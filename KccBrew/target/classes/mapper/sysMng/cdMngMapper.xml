<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="kr.co.kccbrew.sysMng.cdMng.dao.ICdMngRepository">

	<select id="selectNm"
		resultType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
		<![CDATA[
        select distinct
        	grp_cd_id			AS	"cdId", 
        	grp_cd_name		AS	"cdNm", 
        	use_yn			AS	"cdUseYn"
		from 
			group_code
		where 
			use_yn = 'Y'
		order by
			grp_cd_name 
        ]]>
	</select>

	<select id="selectCd" parameterType="String"
		resultType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
		<if test='cdDtlId != "null"'>
			select
			a.grp_cd_id AS "cdId",
			a.grp_cd_name AS "cdNm",
			a.use_yn AS "cdUseYn",
			a.REG_DTTM AS "cdRegDttm",
			a.REG_USER AS
			"cdRegUser",
			a.MOD_DTTM AS "cdModDttm",
			a.MOD_USER AS "cdModUser",
			b.grp_cd_dtl_id AS "cdDtlId",
			b.grp_cd_dtl_nm AS "cdDtlNm",
			b.use_yn AS
			"cdDtlUseYn",
			b.REG_DTTM AS "cdDtlRegDttm",
			b.REG_USER AS
			"cdDtlRegUser",
			b.MOD_DTTM AS "cdDtlModDttm",
			b.MOD_USER AS
			"cdDtlModUser",
			b.GROUP_CODE_IDX AS "cdIdx"
			from
			group_code a,
			group_code_detail b
			where
			a.grp_cd_id =
			b.grp_cd_id(+)
			AND (a.grp_cd_id =
			#{cdId}
			AND b.grp_cd_dtl_id =
			#{cdDtlId})
		</if>
		<if test='cdDtlId == "null"'>
			select
			grp_cd_id AS "cdId",
			grp_cd_name AS "cdNm",
			use_yn AS
			"cdUseYn",
			REG_DTTM AS "cdRegDttm",
			REG_USER AS "cdRegUser",
			MOD_DTTM AS
			"cdModDttm",
			MOD_USER AS "cdModUser"
			from
			group_code
			where
			grp_cd_id =
			#{cdId}
		</if>
	</select>

	<insert id="insert1"
		parameterType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
		<![CDATA[
		 INSERT INTO GROUP_CODE 
		 	(GRP_CD_ID, GRP_CD_NAME, REG_DTTM, REG_USER, MOD_DTTM, MOD_USER, USE_YN)
		VALUES 
			(#{cdId}, #{cdNm}, SYSDATE, #{cdRegUser}, SYSDATE, #{cdModUser}, 'Y')
	]]>
	</insert>

	<insert id="insert2"
		parameterType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
		<![CDATA[
		 INSERT INTO GROUP_CODE_DETAIL
		 	(grp_cd_dtl_id, grp_cd_id, grp_cd_dtl_nm, REG_DTTM, REG_USER, MOD_DTTM, MOD_USER, use_yn, group_code_idx) 
		VALUES 
			(#{cdDtlId}, #{cdId}, #{cdDtlNm}, SYSDATE, #{cdDtlRegUser}, SYSDATE, #{cdDtlModUser}, 'Y', group_code_idx.nextval)
	]]>
	</insert>

	<update id="cdMod"
		parameterType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
	<![CDATA[
		UPDATE 
			GROUP_CODE_DETAIL 
		SET 
			grp_cd_id=#{cdId},
			 grp_cd_dtl_id=#{cdDtlId}, 
			grp_cd_dtl_nm=#{cdDtlNm}, 
			MOD_DTTM = SYSDATE,
			MOD_USER = #{cdDtlModUser},
			use_yn=#{cdDtlUseYn}
		WHERE 
			group_code_idx=#{cdIdx}
			
	]]>
	</update>


	<select id="filter"
		resultType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo"
		parameterType="java.util.Map">

		select
			a.group_code_idx AS "cdIdx",
			a.grp_cd_id AS "cdId",
			a.grp_cd_name AS "cdNm",
			a.use_yn AS "cdDtlUseYn",
			a.grp_cd_dtl_id AS "cdDtlId",
			a.grp_cd_dtl_nm AS "cdDtlNm"
		FROM (
       	 SELECT
            ROW_NUMBER() OVER(ORDER BY b.group_code_idx) AS ROW_NUM,
            b.group_code_idx, a.grp_cd_id, a.grp_cd_name, b.use_yn, b.grp_cd_dtl_id,
			b.grp_cd_dtl_nm
			FROM
			group_code a 
			,
			group_code_detail b 
			WHERE
			 a.grp_cd_id = b.grp_cd_id(+)
 		<if test="CdMngVo.startYr != null and CdMngVo.startYr != '' and CdMngVo.startMn != null and CdMngVo.startMn != ''">
                 <![CDATA[
                  AND (
                    EXTRACT(YEAR FROM a.REG_DTTM) > #{CdMngVo.startYr}
                    OR (EXTRACT(YEAR FROM a.REG_DTTM) = #{CdMngVo.startYr} AND EXTRACT(MONTH FROM a.REG_DTTM) >= #{CdMngVo.startMn})
                )
                  ]]>
            </if>
            <if test="CdMngVo.endYr != null and CdMngVo.endYr != '' and CdMngVo.endMn != null and CdMngVo.endMn != ''">
                  <![CDATA[
                AND (
                    EXTRACT(YEAR FROM a.REG_DTTM) < #{CdMngVo.endYr}
                    OR (EXTRACT(YEAR FROM a.REG_DTTM) = #{CdMngVo.endYr} AND EXTRACT(MONTH FROM a.REG_DTTM) <= #{CdMngVo.endMn})
                )
                  ]]>
            </if>
           
            <if test="CdMngVo.keyword != null and CdMngVo.keyword != ''">
               AND
			b.grp_cd_dtl_nm LIKE '%'||#{CdMngVo.keyword}||'%'
            </if>
			<if test="CdMngVo.cdId != null and CdMngVo.cdId != ''">
			AND a.grp_cd_id = #{CdMngVo.cdId}
			</if>
		<if test="CdMngVo.cdUseYn != null and CdMngVo.cdUseYn != ''">
			and a.use_yn = #{CdMngVo.cdUseYn}
		</if>
		  ) a
    WHERE ROW_NUM BETWEEN #{firstRowNum} AND #{lastRowNum}

	</select>

<select id="getCdFilterCount"
		parameterType="java.util.Map"
		resultType="java.lang.Integer">
		SELECT COUNT(*) FROM (
		 SELECT
            ROW_NUMBER() OVER(ORDER BY b.group_code_idx) AS ROW_NUM,
            b.group_code_idx AS "cdIdx",
			a.grp_cd_id AS "cdId",
			a.grp_cd_name AS "cdNm",
			a.use_yn AS "cdUseYn",
			b.grp_cd_dtl_id AS "cdDtlId",
			b.grp_cd_dtl_nm AS "cdDtlNm"
          FROM
			group_code a 
			,
			group_code_detail b 
			WHERE
			 a.grp_cd_id = b.grp_cd_id(+)
        	<if test="CdMngVo.startYr != null and CdMngVo.startYr != '' and CdMngVo.startMn != null and CdMngVo.startMn != ''">
                 <![CDATA[
                  AND (
                    EXTRACT(YEAR FROM a.REG_DTTM) > #{CdMngVo.startYr}
                    OR (EXTRACT(YEAR FROM a.REG_DTTM) = #{CdMngVo.startYr} AND EXTRACT(MONTH FROM a.REG_DTTM) >= #{CdMngVo.startMn})
                )
                  ]]>
            </if>
            <if test="CdMngVo.endYr != null and CdMngVo.endYr != '' and CdMngVo.endMn != null and CdMngVo.endMn != ''">
                  <![CDATA[
                AND (
                    EXTRACT(YEAR FROM a.REG_DTTM) < #{CdMngVo.endYr}
                    OR (EXTRACT(YEAR FROM a.REG_DTTM) = #{CdMngVo.endYr} AND EXTRACT(MONTH FROM a.REG_DTTM) <= #{CdMngVo.endMn})
                )
                  ]]>
            </if>
           
            <if test="CdMngVo.keyword != null and CdMngVo.keyword != ''">
               AND
			b.grp_cd_dtl_nm LIKE '%'||#{CdMngVo.keyword}||'%'
            </if>
			<if test="CdMngVo.cdId != null and CdMngVo.cdId != ''">
			AND a.grp_cd_id = #{CdMngVo.cdId}
			</if>
		<if test="CdMngVo.cdUseYn != null and CdMngVo.cdUseYn != ''">
			and a.use_yn = #{CdMngVo.cdUseYn}
		</if>
		  )
		  </select>
		  
	<select id="selectGrpDetail" parameterType="string"
		resultType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
		<![CDATA[
		select
			grp_cd_id AS "cdId",
			grp_cd_name AS "cdNm",
			use_yn AS
			"cdUseYn",
			REG_DTTM AS "cdRegDttm",
			REG_USER AS "cdRegUser",
			MOD_DTTM AS
			"cdModDttm",
			MOD_USER AS "cdModUser"
			from
			group_code
			where
			grp_cd_id =
			#{cdId}
			 ]]>
	</select>

	<update id="grpUpdate1"
		parameterType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
    <![CDATA[
    UPDATE 
        GROUP_CODE
    SET 
        grp_cd_name = #{cdNm}, 
        MOD_DTTM = SYSDATE,
        MOD_USER = #{cdModUser},
        use_yn = #{cdUseYn}
    WHERE 
        grp_cd_id = #{cdId}
    ]]>
	</update>

	<update id="grpUpdate2"
		parameterType="kr.co.kccbrew.sysMng.cdMng.model.CdMngVo">
		<if test="'N'.equals(cdUseYn)">
			UPDATE
			GROUP_CODE_DETAIL
			SET
			MOD_DTTM = SYSDATE,
			MOD_USER = #{cdModUser},
			use_yn = #{cdUseYn}  <!-- Change jdbcType to VARCHAR -->
			WHERE
			grp_cd_id = #{cdId}
		</if>
		<if test="'Y'.equals(cdUseYn)">
			UPDATE
			GROUP_CODE_DETAIL
			SET
			use_yn = #{cdUseYn}  <!-- Change jdbcType to VARCHAR -->
			WHERE
			grp_cd_id = #{cdId}
			and
			use_yn ='Y'
		</if>

	</update>

</mapper>