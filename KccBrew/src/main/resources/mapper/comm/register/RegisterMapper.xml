<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.kccbrew.comm.register.dao.IRegisterRepository">

<!-- 점포 목록 조회 -->
<select id="selectStoreList" parameterType="hashmap" resultType="kr.co.kccbrew.comm.register.model.StoreListVo">
<![CDATA[
	SELECT store_seq AS "storeSeq",
			store_nm AS "storeNm",
			store_addr AS "storeAddr",
			store_telno AS "storeTelNo"
    FROM (SELECT rownum AS rnum,
            store_seq,
			store_nm,
			store_addr,
			store_telno
        FROM store
        WHERE use_yn='Y' AND (store_nm LIKE '%'||#{keyword}||'%' or store_addr LIKE '%'||#{keyword}||'%')
        )
    WHERE rnum BETWEEN #{start} AND #{end} 
]]>
</select>

<!-- 조회한 점포 총 갯수 -->
<select id="countStoreList" parameterType="string" resultType="integer">
<![CDATA[
	SELECT COUNT(*) FROM store 
	WHERE use_yn='Y' AND (store_nm LIKE '%'||#{keyword}||'%' or store_addr LIKE '%'||#{keyword}||'%')
]]>
</select>

<!-- 운영중인 장비 코드 조회 -->
<select id="selectMechineCode" resultType="kr.co.kccbrew.comm.register.model.MechineListVo">
<![CDATA[
	SELECT 	grp_cd_dtl_id AS "grpCdDtlId",
			grp_cd_id AS "grpCdId",
			grp_cd_dtl_nm AS "grpCdDtlNm"
	FROM group_code_detail
	WHERE use_yn='Y' AND grp_cd_id='M'
	ORDER BY group_code_idx
]]>
</select>

<!-- 사용자 아이디 중복 체크 -->
<select id="checkUserId" parameterType="string" resultType="integer">
<![CDATA[
	SELECT COUNT(*) FROM users WHERE user_id=#{userId}
]]>
</select>

<!-- 지역 코드 조회 -->
<select id="selectLocationCd" resultType="kr.co.kccbrew.comm.register.model.LocationListVo">
<![CDATA[
	SELECT grp_cd_dtl_id AS "grpCdDtlId",
			grp_cd_id AS "grpCdId",
			grp_cd_dtl_nm AS "grpCdDtlNm"
	FROM group_code_detail
	WHERE grp_cd_id='L'
]]>
</select>

<!-- 지역 상세 코드 조회 -->
<select id="selectLocationDtlCd" parameterType="string" resultType="kr.co.kccbrew.comm.register.model.LocationListVo">
<![CDATA[
	SELECT grp_cd_dtl_id AS "grpCdDtlId",
			grp_cd_id AS "grpCdId",
			grp_cd_dtl_nm AS "grpCdDtlNm"
	FROM group_code_detail
	WHERE grp_cd_id='LL' AND grp_cd_dtl_id LIKE #{locationCd}||'%'
]]>
</select>

<!-- 사용자 사진 기본 정보 등록 -->
<insert id="insertFileInfo" parameterType="kr.co.kccbrew.comm.register.model.UserImgVo">
	INSERT INTO file_info VALUES(file_seq.NEXTVAL,'F',SYSDATE,#{userId},SYSDATE,#{userId})
	<selectKey resultType="int" keyProperty="fileSeq" order="AFTER">
			SELECT NVL(MAX(file_seq), 0) AS "fileSeq" FROM file_info
	</selectKey>
</insert>

<!-- 사용자 사진 상세 정보 등록 -->
<insert id="insertFileDtlInfo" parameterType="kr.co.kccbrew.comm.register.model.UserImgVo">
<![CDATA[
	INSERT INTO file_detail_info VALUES(
			file_dtl_seq.NEXTVAL,
			#{fileSeq},
			#{fileOriginalNm},
			#{storageLocation},
			SYSDATE,
			#{userId},
			SYSDATE,
			#{fileServerNm},
			#{fileFmt},
			#{userId})
]]>
</insert>

<!-- 회원가입 -->	
<insert id="registerUser" parameterType="kr.co.kccbrew.comm.register.model.UserVo">
	INSERT INTO users
	VALUES(
			#{userId}, 
			#{userPwd}, 
			#{userNm}, 
			#{userTelNo}, 
			#{userEmail}, 
			#{userAddr}, 
			<choose>
				<when test="eqpmnCd != null">
					#{eqpmnCd},
				</when>
				<otherwise>
					null,
				</otherwise>
			</choose>
			<choose>
				<when test="fileSeq != null">
					#{fileSeq},
				</when>
				<otherwise>
					null,
				</otherwise>
			</choose>
			<choose>
				<when test="locationCd != null">
					#{locationCd},
				</when>
				<otherwise>
					null,
				</otherwise>
			</choose>
			#{userTypeCd},
			SYSDATE,
			SYSDATE,
			'Y',
			'N',
			#{userSalt} 
		) 
</insert>

<insert id="insertStoreUserMap" parameterType="hashmap">
<![CDATA[
	INSERT INTO store_user_map VALUES(#{storeId},#{userId})
]]>
</insert>
</mapper>